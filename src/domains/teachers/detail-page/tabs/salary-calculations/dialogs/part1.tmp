/**
 * SalaryCalculationDetailDialog - Detailed breakdown of salary calculation
 * Phase 7.5 implementation
 */
import React, { useState } from 'react';
import { AlertCircle, CheckCircle, RotateCcw, Info } from 'lucide-react';
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
} from '@/components/ui/dialog';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { Alert, AlertDescription } from '@/components/ui/alert';
import {
  Card,
  CardContent,
  CardDescription,
  CardHeader,
  CardTitle,
} from '@/components/ui/card';
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
  TableFooter,
} from '@/components/ui/table';
import {
  Tooltip,
  TooltipContent,
  TooltipProvider,
  TooltipTrigger,
} from '@/components/ui/tooltip';
import { Separator } from '@/components/ui/separator';
import LoadingSpinner from '@/components/common/LoadingSpinner';
import { useTeacherSalaryCalculationDetail } from '../../../hooks/useTeacherSalaryCalculationDetail';
import {
  SalaryCalculationStatus,
  type SalaryCalculation,
  type SalaryCalculationItem,
  type SalaryAuditLog,
} from '@/domains/teachers/_shared/types/salaryCalculation.types';
import { ApproveSalaryDialog, ReopenSalaryDialog } from './index';

interface SalaryCalculationDetailDialogProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  calculation: SalaryCalculation | null;
  onSuccess?: () => void;
}

export const SalaryCalculationDetailDialog: React.FC<SalaryCalculationDetailDialogProps> = ({
  open,
  onOpenChange,
  calculation,
  onSuccess,
}) => {
  const [approveDialogOpen, setApproveDialogOpen] = useState(false);
  const [reopenDialogOpen, setReopenDialogOpen] = useState(false);

  const { detail, loading, error, refetch } = useTeacherSalaryCalculationDetail({
    calculationId: calculation?.id || null,
    isOpen: open,
  });

  const formatCurrency = (amount: number): string => {
    return new Intl.NumberFormat('vi-VN', {
      style: 'currency',
      currency: 'VND',
      minimumFractionDigits: 0,
    }).format(amount);
  };

  const formatPeriod = (start: string, end: string): string => {
    const startDate = new Date(start);
    const endDate = new Date(end);
    const startMonth = startDate.toLocaleDateString('en-US', { month: 'long' });
    const startDay = startDate.getDate();
    const endDay = endDate.getDate();
    const year = endDate.getFullYear();
    return startMonth + ' ' + startDay + ' - ' + endDay + ', ' + year;
  };

  const formatRelativeTime = (dateString: string): string => {
    const date = new Date(dateString);
    const now = new Date();
    const diffMs = now.getTime() - date.getTime();
    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
    if (diffDays === 0) return 'Today';
    if (diffDays === 1) return 'Yesterday';
    if (diffDays < 7) return diffDays + ' days ago';
    if (diffDays < 30) {
      const weeks = Math.floor(diffDays / 7);
      return weeks + (weeks > 1 ? ' weeks' : ' week') + ' ago';
    }
    if (diffDays < 365) {
      const months = Math.floor(diffDays / 30);
      return months + (months > 1 ? ' months' : ' month') + ' ago';
    }
    return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
  };
