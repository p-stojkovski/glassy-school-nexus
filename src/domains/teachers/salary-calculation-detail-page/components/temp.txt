  const renderClassBreakdown = (items: SalaryCalculationItem[]) => {
    const totalAmount = items.reduce((sum, item) => sum + item.amount, 0);
    const totalLessons = items.reduce((sum, item) => sum + item.lessonsCount, 0);

    // Group items by classId to show multiple tiers per class
    const byClass = items.reduce((acc, item) => {
      const key = item.classId;
      if (!acc[key]) {
        acc[key] = { className: item.className, tiers: [] };
      }
      acc[key].tiers.push(item);
      return acc;
    }, {} as Record<string, { className: string; tiers: SalaryCalculationItem[] }>);

    // Check if any items have per-lesson tracking (studentCountAtLesson not null)
    const hasPerLessonTracking = items.some(item => item.studentCountAtLesson !== null);

    return (
      <Card className="bg-white/[0.02] border-white/10">
        <CardHeader>
          <CardTitle className="text-white text-lg">Class Breakdown</CardTitle>
          <CardDescription className="text-white/60">
            {hasPerLessonTracking
              ? 'Per-tier breakdown based on student count at lesson time'
              : 'Breakdown by class with applied rate tiers'}
          </CardDescription>
        </CardHeader>
        <CardContent>
          <Table>
            <TableHeader>
              <TableRow>
                <TableHead className="text-white/70">Class</TableHead>
                <TableHead className="text-white/70 text-center">Students</TableHead>
                <TableHead className="text-white/70 text-center">Lessons</TableHead>
                <TableHead className="text-white/70 text-right">Rate</TableHead>
                <TableHead className="text-white/70 text-right">Amount</TableHead>
              </TableRow>
            </TableHeader>
            <TableBody>
              {Object.entries(byClass).map(([classId, classData]) => (
                <React.Fragment key={classId}>
                  {classData.tiers.map((tier, idx) => (
                    <TableRow key={`${classId}-${tier.studentCountAtLesson ?? 'legacy'}-${idx}`}>
                      {idx === 0 ? (
                        <TableCell
                          className="text-white font-medium align-top"
                          rowSpan={classData.tiers.length}
                        >
                          {classData.className}
                        </TableCell>
                      ) : null}
                      <TableCell className="text-white/80 text-center">
                        <TooltipProvider>
                          <Tooltip>
                            <TooltipTrigger asChild>
                              <span className="cursor-help inline-flex items-center gap-1">
                                {tier.studentCountAtLesson !== null ? (
                                  <Badge variant="outline" className="border-white/20 text-white/80 text-xs">
                                    {tier.studentCountAtLesson}
                                  </Badge>
                                ) : (
                                  <span className="text-white/40 text-sm flex items-center gap-1">
                                    N/A
                                    <Info className="w-3 h-3" />
                                  </span>
                                )}
                              </span>
                            </TooltipTrigger>
                            <TooltipContent className="bg-[#1a1f2e] border-white/20">
                              <div className="text-xs space-y-1">
                                {tier.studentCountAtLesson !== null ? (
                                  <>
                                    <p className="text-white font-medium">Student count at lesson time</p>
                                    <p className="text-white/70">Rate Tier: {tier.ruleSnapshot.minStudents}+ students</p>
                                    <p className="text-white/70">
                                      Effective: {new Date(tier.ruleSnapshot.effectiveFrom).toLocaleDateString()}
                                    </p>
                                  </>
                                ) : (
                                  <>
                                    <p className="text-white font-medium">Legacy lesson</p>
                                    <p className="text-white/70">Student count not captured</p>
                                    <p className="text-white/70">Using current count: {tier.activeStudents}</p>
                                  </>
                                )}
                              </div>
                            </TooltipContent>
                          </Tooltip>
                        </TooltipProvider>
                      </TableCell>
                      <TableCell className="text-white/80 text-center">
                        {tier.lessonsCount}
                      </TableCell>
                      <TableCell className="text-white/80 text-right">
                        {formatCurrency(tier.rateApplied)}
                      </TableCell>
                      <TableCell className="text-white font-medium text-right">
                        {formatCurrency(tier.amount)}
                      </TableCell>
                    </TableRow>
                  ))}
                </React.Fragment>
              ))}
            </TableBody>
            <TableFooter className="bg-white/5">
              <TableRow>
                <TableCell className="text-white font-semibold">Total</TableCell>
                <TableCell />
                <TableCell className="text-white/80 text-center font-medium">
                  {totalLessons}
                </TableCell>
                <TableCell />
                <TableCell className="text-white font-semibold text-right">
                  {formatCurrency(totalAmount)}
                </TableCell>
              </TableRow>
            </TableFooter>
          </Table>
        </CardContent>
      </Card>
